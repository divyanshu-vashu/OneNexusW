I WANT MIDDLE LAYER
WHEN I CREATE A DEVICE THEN IT SHOULD HAVE DROP DROP DOWN , WILL ASK FOR ADD SWITCH ,AND THERE IS ONE ADD BUTTON USER CAN ADD IT TILL PIN 8 ONLY INTERNAL STATE CHECK , IF I EXPLAIN  MY PROJECT WE ARE SELLING IOPT DEVICE WHICH 4-8 PORT AND ONE DEVICE HAVE ESP SO WE CAN IDENTIFY WITH MAC ADDRESS AND USER CAN CONNECT THE SWITCH INTO IT , SO THAT IT WILL POWER IT CURRECT CODE HAVE WHEN USER ADD DEVICE IT GOES IN DASHBOARD CONTROL THAT IS ON /OFF BUT I WANT DEVICE > LIST OF SWITCH > EACH SWITCH WILL OPEN DASH BOARD , I F I HAVSRE BACKEND API THEN U MAY GET CLEAR PICTURE

Okay, I understand your goal perfectly. You want to introduce an intermediate "switch/port management" layer between the device list and the individual switch control, and refine the functionalities to align with your provided backend API.
Here's the plan to implement this "middle layer" and refactor the device and switch control flow:
Key Changes:
Refactor lib/deviceApi.js: Add new API calls for device updates, port management, and specific pin status.
Refactor hooks/useDevices.js: Integrate the new API calls and provide more granular functions for device and port operations.
Update app/dashboard/page.js:
Integrate with the useDevices hook to fetch and display devices from the backend.
Modify the "Add Device" and "Edit Device" functionalities to interact with the backend API.
Change the "Open" button for a device to navigate to a new page that lists its switches (ports).
Remove the existing inline port management and scheduling forms, as this functionality will be moved to dedicated pages.
Create app/device/[mac]/page.js (New Purpose: Device Details / Port Listing Page): This page will now list all the switches (ports) for a given device identified by its MAC address. It will also allow adding new switches.
Create app/device/[mac]/[pin]/page.js (New Page: Individual Switch Control Page): This page will handle the real-time status toggling and scheduling for a specific switch (port) on a specific device.



### Step 1: Update lib/deviceApi.js
We'll add functions to interact with the device update, port management, and specific pin status endpoints.
code
JavaScript
// lib/deviceApi.js
import apiClient from './apiClient';

// Device operations
export async function getDevices() {
  return apiClient.get('/api/v1/devices');
}

export async function addDevice(macAddress, name) {
  return apiClient.post('/api/v1/devices', { macAddress, name });
}

export async function updateDevice(macAddress, name) {
  return apiClient.put(`/api/v1/devices/${macAddress}`, { name });
}

// --- New functions for Port Management ---
export async function getPortsForDevice(macAddress) {
  return apiClient.get(`/api/v1/devices/${macAddress}/ports`);
}

export async function addPortToDevice(macAddress, name, pin) {
  return apiClient.post(`/api/v1/devices/${macAddress}/ports`, { name, pin });
}

// --- Specific Pin Operations ---
export async function getPinStatus(macAddress, pin) {
  // Note: The backend API you provided for `get toggle status -esp` uses `x-esp-api-key`
  // but `apiClient` already adds `Authorization: Bearer <token>`.
  // If the backend truly expects `x-esp-api-key` for this endpoint (typically for ESP devices themselves),
  // then the `apiClient` might need a modification or a custom axios instance for this specific call.
  // For now, I will assume the `Bearer Token` is sufficient for fetching status *from your backend*.
  // If it fails, we might need a specific `apiClientEsp` for these calls.
  return apiClient.get(`/api/v1/devices/${macAddress}/${pin}/curStatus`);
}

export async function togglePinStatus(macAddress, pin, state) {
  // Similar note as above for x-esp-api-key
  // Assuming 'state' is '0' or '1'
  return apiClient.put(`/api/v1/devices/${macAddress}/${pin}/${state}`, null, {
    headers: {
      // If the backend specifically requires x-esp-api-key for this,
      // and not the Bearer token, you'd need to uncomment this or use a separate API client.
      // 'x-esp-api-key': macAddress
    }
  });
}

// Schedule operations (remain the same, but we'll use them with switchPin)
export async function getSchedules() {
  return apiClient.get('/api/v1/schedules');
}

export async function createSchedule(scheduleData) {
  // scheduleData should include name, macSymbolId, switchPin, scheduleTimes
  return apiClient.post('/api/v1/schedules', scheduleData);
}

export async function deleteSchedule(scheduleId) {
  return apiClient.delete(`/api/v1/schedules/${scheduleId}`);
}

### Step 2: Update hooks/useDevices.js
This hook will now manage devices, their ports, and associated schedules more comprehensively.
code
JavaScript
// hooks/useDevices.js
import { useState, useEffect, useCallback } from 'react';
import {
  getDevices,
  addDevice as addDeviceApi, // Renamed to avoid conflict
  updateDevice as updateDeviceApi, // Renamed
  getPortsForDevice,
  addPortToDevice,
  getPinStatus,
  togglePinStatus,
  getSchedules,
  createSchedule as createScheduleApi, // Renamed
  deleteSchedule as deleteScheduleApi, // Renamed
} from '@/lib/deviceApi';

export function useDevices() {
  const [devices, setDevices] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const clearError = () => setError(null);

  // Fetch all devices
  const fetchDevices = useCallback(async () => {
    try {
      setLoading(true);
      clearError();
      const response = await getDevices();
      setDevices(response.data.devices || []); // Assuming the API returns { devices: [...] }
    } catch (err) {
      setError(err.response?.data?.message || err.message || 'Failed to fetch devices');
      console.error('Error fetching devices:', err);
    } finally {
      setLoading(false);
    }
  }, []);

  // Add a new device
  const addDevice = async (macAddress, name) => {
    try {
      setLoading(true);
      clearError();
      const response = await addDeviceApi(macAddress, name);
      await fetchDevices(); // Refresh list after adding
      return { success: true, device: response.data.device };
    } catch (err) {
      const errorMsg = err.response?.data?.message || 'Failed to add device';
      setError(errorMsg);
      console.error('Error adding device:', err);
      return { success: false, error: errorMsg };
    } finally {
      setLoading(false);
    }
  };

  // Update existing device
  const updateDevice = async (macAddress, name) => {
    try {
      setLoading(true);
      clearError();
      await updateDeviceApi(macAddress, name);
      setDevices(prev => prev.map(d => (d.macAddress === macAddress ? { ...d, name } : d)));
      return { success: true };
    } catch (err) {
      const errorMsg = err.response?.data?.message || 'Failed to update device';
      setError(errorMsg);
      console.error('Error updating device:', err);
      return { success: false, error: errorMsg };
    } finally {
      setLoading(false);
    }
  };


  // --- Port-specific operations (will be used in the new DevicePortsPage) ---
  const fetchPortsForDevice = useCallback(async (macAddress) => {
    try {
      setLoading(true);
      clearError();
      const response = await getPortsForDevice(macAddress);
      return { success: true, ports: response.data.ports || [] }; // Assuming API returns { ports: [...] }
    } catch (err) {
      const errorMsg = err.response?.data?.message || `Failed to fetch ports for ${macAddress}`;
      setError(errorMsg);
      console.error('Error fetching ports:', err);
      return { success: false, error: errorMsg, ports: [] };
    } finally {
      setLoading(false);
    }
  }, []);

  const addPort = async (macAddress, name, pin) => {
    try {
      setLoading(true);
      clearError();
      const response = await addPortToDevice(macAddress, name, pin);
      // No need to fetch all devices here, but if we want to update the device.portsCount,
      // we'd update the local `devices` state or re-fetch device details.
      return { success: true, port: response.data.port };
    } catch (err) {
      const errorMsg = err.response?.data?.message || 'Failed to add port';
      setError(errorMsg);
      console.error('Error adding port:', err);
      return { success: false, error: errorMsg };
    } finally {
      setLoading(false);
    }
  };

  const fetchPinStatus = useCallback(async (macAddress, pin) => {
    try {
      // No setLoading(true) here as this might be called frequently
      clearError();
      const response = await getPinStatus(macAddress, pin);
      return { success: true, status: response.data.status }; // Assuming { status: '0' or '1' }
    } catch (err) {
      const errorMsg = err.response?.data?.message || `Failed to get status for pin ${pin}`;
      setError(errorMsg);
      console.error('Error fetching pin status:', err);
      return { success: false, error: errorMsg, status: 'unknown' };
    }
  }, []);

  const togglePinStatus = async (macAddress, pin, currentState) => {
    try {
      setLoading(true);
      clearError();
      const newState = currentState === '1' ? '0' : '1';
      await togglePinStatus(macAddress, pin, newState);
      return { success: true, newState };
    } catch (err) {
      const errorMsg = err.response?.data?.message || 'Failed to toggle pin status';
      setError(errorMsg);
      console.error('Error toggling pin status:', err);
      return { success: false, error: errorMsg };
    } finally {
      setLoading(false);
    }
  };

  // --- Schedule operations (will be filtered by mac and pin in component) ---
  const fetchSchedules = useCallback(async () => {
    try {
      setLoading(true);
      clearError();
      const response = await getSchedules();
      return { success: true, schedules: response.data.schedules || [] }; // Assuming API returns { schedules: [...] }
    } catch (err) {
      const errorMsg = err.response?.data?.message || 'Failed to fetch schedules';
      setError(errorMsg);
      console.error('Error fetching schedules:', err);
      return { success: false, error: errorMsg, schedules: [] };
    } finally {
      setLoading(false);
    }
  }, []);

  const createSchedule = async (scheduleData) => {
    try {
      setLoading(true);
      clearError();
      const response = await createScheduleApi(scheduleData);
      return { success: true, schedule: response.data.schedule };
    } catch (err) {
      const errorMsg = err.response?.data?.message || 'Failed to create schedule';
      setError(errorMsg);
      console.error('Error creating schedule:', err);
      return { success: false, error: errorMsg };
    } finally {
      setLoading(false);
    }
  };

  const deleteSchedule = async (scheduleId) => {
    try {
      setLoading(true);
      clearError();
      await deleteScheduleApi(scheduleId);
      return { success: true };
    } catch (err) {
      const errorMsg = err.response?.data?.message || 'Failed to delete schedule';
      setError(errorMsg);
      console.error('Error deleting schedule:', err);
      return { success: false, error: errorMsg };
    } finally {
      setLoading(false);
    }
  };

  // Initial data fetch for devices
  useEffect(() => {
    fetchDevices();
  }, [fetchDevices]);

  return {
    devices,
    loading,
    error,
    clearError,
    addDevice,
    updateDevice,
    fetchDevices, // Expose for manual refresh
    fetchPortsForDevice,
    addPort,
    fetchPinStatus,
    togglePinStatus,
    fetchSchedules,
    createSchedule,
    deleteSchedule,
  };
}



### Step 3: Update app/dashboard/page.js
This page will now focus on listing devices and linking to the new port-listing page. All local state management for ports and schedules will be removed.


// app/dashboard/page.js
"use client";
import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import withAuth from "../../lib/withAuth";
import { useDevices } from "../../hooks/useDevices"; // Import the hook

function DashboardPage() {
  const { devices, loading, error, addDevice, updateDevice, fetchDevices, clearError } = useDevices(); // Use the hook
  const [newMac, setNewMac] = useState("");
  const [newName, setNewName] = useState("");
  const [editingDevice, setEditingDevice] = useState(null);
  const router = useRouter();
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  // Re-fetch devices on mount (already done by useDevices, but can be explicit if needed)
  useEffect(() => {
    fetchDevices();
  }, [fetchDevices]);

  // Inject custom CSS (keep as is for now, but consider refactoring)
  useEffect(() => {
    const styleElement = document.createElement("style");
    styleElement.textContent = `
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

      html { scroll-behavior: smooth; }
      body {
        font-family: 'Inter', sans-serif !important;
        overflow-y: scroll;
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
      }
      body::-webkit-scrollbar { width: 8px; }
      body::-webkit-scrollbar-track { background: transparent; }
      body::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        border: 2px solid transparent;
        background-clip: content-box;
      }
      body::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.4); }

      /* HEADER */
      .header {
        position: fixed; top: 0; left: 0; right: 0;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(229, 231, 235, 0.5);
        z-index: 40; padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
      }
      .header-container {
        max-width: 80rem; margin: 0 auto;
        display: flex; align-items: center; justify-content: space-between;
      }
      .logo {
        display: flex; align-items: center; gap: 0.75rem;
        text-decoration: none; color: #1f2937;
        font-weight: 800; font-size: 1.5rem;
        transition: color 0.3s ease;
      }
      .logo:hover { color: #2563eb; }
      .logo-icon {
        width: 2.5rem; height: 2.5rem;
        background: linear-gradient(to right, #3b82f6, #06b6d4);
        border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;
        color: white; font-weight: 700;
      }
      .nav-desktop { display: none; align-items: center; gap: 2rem; }
      @media (min-width: 1024px) { .nav-desktop { display: flex; } }
      .nav-link {
        color: #374151; text-decoration: none;
        font-weight: 500; padding: 0.5rem 1rem;
        border-radius: 0.5rem; transition: all 0.3s ease;
      }
      .nav-link:hover { color: #2563eb; background-color: #f3f4f6; }
      .nav-buttons { display: none; align-items: center; gap: 1rem; }
      @media (min-width: 1024px) { .nav-buttons { display: flex; } }
      .header-btn {
        padding: 0.5rem 1rem; border-radius: 0.5rem;
        font-weight: 600; text-decoration: none;
        transition: all 0.3s ease; border: none; cursor: pointer;
      }
      .btn-login { color: #374151; background: transparent; }
      .btn-login:hover { background-color: #f3f4f6; }
      .btn-register { color: white; background-color: #2563eb; }
      .btn-register:hover { background-color: #1d4ed8; }
      .btn-logout {
        color: white; background: linear-gradient(to right, #dc2626, #b91c1c);
      }
      .btn-logout:hover {
        background: linear-gradient(to right, #b91c1c, #991b1b);
      }
      .mobile-menu-btn { display: block; background: none; border: none; padding: 0.5rem; cursor: pointer; }
      @media (min-width: 1024px) { .mobile-menu-btn { display: none; } }
      .mobile-menu {
        position: absolute; top: 100%; left: 0; right: 0;
        background: white; border-bottom: 1px solid rgba(229, 231, 235, 0.5);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        display: none; padding: 1rem;
      }
      .mobile-menu.open { display: block; }
      .mobile-nav-links {
        display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;
      }
      .mobile-nav-buttons { display: flex; flex-direction: column; gap: 0.5rem; }

      /* DASHBOARD */
      .dashboard-container {
        min-height: 100vh;
        background: linear-gradient(135deg, #f8faff 0%, #ffffff 100%);
        padding: 8rem 1.5rem 5rem 1.5rem;
        position: relative; overflow: hidden;
      }
      .dashboard-container::before {
        content: ''; position: absolute; top: 0; right: -50%;
        width: 100%; height: 100%;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
        border-radius: 50%; z-index: 1;
      }
      .dashboard-content { max-width: 80rem; margin: 0 auto; position: relative; z-index: 2; }
      .dashboard-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 3rem; flex-wrap: wrap; gap: 1rem;
      }
      .dashboard-title {
        font-size: 2.5rem; font-weight: 800; color: #111827; line-height: 1.1; margin: 0;
      }
      @media (min-width: 768px) { .dashboard-title { font-size: 3rem; } }
      .dashboard-welcome { color: #6b7280; font-size: 1.125rem; margin-top: 0.5rem; }

      .add-device-card {
        background: white;
        border-radius: 1.5rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: 1px solid rgba(229, 231, 235, 0.5);
        backdrop-filter: blur(10px);
        padding: 2.5rem;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
      }
      .add-device-card:hover {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }
      .card-title {
        font-size: 1.5rem; font-weight: 700; color: #111827;
        margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem;
      }
      .card-icon {
        width: 2rem; height: 2rem;
        background: linear-gradient(to right, #3b82f6, #06b6d4);
        border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; color: white;
      }
      .card-description { color: #6b7280; margin-bottom: 2rem; line-height: 1.6; }
      .form-grid { display: grid; gap: 1.5rem; margin-bottom: 2rem; }
      @media (min-width: 768px) { .form-grid { grid-template-columns: 1fr 1fr auto; } }
      .input-group { display: flex; flex-direction: column; gap: 0.5rem; }
      .input-label { font-weight: 600; color: #374151; font-size: 0.875rem; }
      .form-input {
        padding: 0.875rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #f9fafb;
      }
      .form-input:focus {
        outline: none; border-color: #2563eb;
        background: white; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }
      .form-input::placeholder { color: #9ca3af; }
      .add-button {
        background: linear-gradient(to right, #2563eb, #1d4ed8);
        color: white; padding: 0.875rem 2rem;
        border-radius: 0.75rem; font-weight: 600;
        border: none; cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
        display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        height: fit-content; align-self: end; white-space: nowrap;
      }
      .add-button:hover {
        background: linear-gradient(to right, #1d4ed8, #1e40af);
        transform: translateY(-1px);
        box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
      }
      .help-text {
        background: #f0f9ff; border: 1px solid #0ea5e9;
        border-radius: 0.75rem; padding: 1rem; margin-top: 1rem;
        font-size: 0.875rem; color: #0369a1; line-height: 1.5;
      }
      .help-icon { width: 1rem; height: 1rem; display: inline; margin-right: 0.5rem; color: #0ea5e9; }

      /* Devices List */
      .devices-list { list-style: none; padding: 0; margin: 0; }
      .device-item {
        padding: 1rem; border-bottom: 1px solid #e5e7eb;
        display: flex; justify-content: space-between; align-items: center;
      }
      .device-item:last-child { border-bottom: none; }
      .device-info { color: #374151; }
      .device-name { font-weight: 600; }
      .device-mac { font-size: 0.875rem; color: #6b7280; }
      .device-link {
        color: #2563eb; font-weight: 500; text-decoration: none;
      }
      .device-link:hover { text-decoration: underline; }

      /* Port Management Styles (moved from previous version, not used directly here) */
      .ports-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; }
      .port-item { background: white; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb; }
      .port-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
      .port-name { font-weight: 600; color: #374151; }
      .port-actions { display: flex; align-items: center; gap: 0.5rem; }
      .port-schedule { margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #e5e7eb; }
      .schedule-form { display: grid; grid-template-columns: 2fr 1.5fr 2fr auto; gap: 0.5rem; margin: 1rem 0; }
      .schedule-list { display: flex; flex-direction: column; gap: 0.5rem; }
      .schedule-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f9fafb; border-radius: 0.375rem; border: 1px solid #e5e7eb; }
      .btn-icon { background: none; border: none; cursor: pointer; padding: 0.25rem; border-radius: 0.25rem; color: #6b7280; transition: all 0.2s ease; }
      .btn-icon:hover { background: #f3f4f6; color: #ef4444; }
      .btn-small { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; font-size: 0.875rem; border: 1px solid #d1d5db; background: white; color: #374151; cursor: pointer; transition: all 0.2s ease; }
      .btn-small:hover { background: #f9fafb; border-color: #9ca3af; }
      .btn-primary {
        background: linear-gradient(to right, #2563eb, #1d4ed8);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .btn-primary:hover {
        background: linear-gradient(to right, #1d4ed8, #1e40af);
      }
      .btn-secondary {
        background: white;
        color: #374151;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        border: 1px solid #d1d5db;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .btn-secondary:hover {
        background: #f9fafb;
      }
      /* Toggle Switch */
      .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
      .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
      input:checked + .slider { background-color: #2563eb; }
      input:checked + .slider:before { transform: translateX(26px); }
      .form-actions { display: flex; gap: 0.5rem; align-items: center; }
      .input-with-button { display: flex; gap: 0.5rem; }
      .device-actions { display: flex; gap: 0.5rem; align-items: center; }
      .device-ports-count { font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem; }
      .error-message {
        background-color: #fee2e2;
        border: 1px solid #fca5a5;
        color: #991b1b;
        padding: 0.75rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        text-align: center;
      }
      .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-top: 4px solid #2563eb;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin-left: 0.5rem;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(styleElement);
    return () => { document.head.removeChild(styleElement); };
  }, []);

  const normalizeMac = (mac) => {
    let cleaned = mac.replace(/[^0-9A-Fa-f]/g, "");
    if (cleaned.length !== 12) return null;
    return cleaned.match(/.{2}/g).join(":").toUpperCase();
  };

  const handleAddDevice = async () => {
    if (!newMac.trim() || !newName.trim()) {
      alert("Please enter both MAC Address and Device Name.");
      return;
    }

    const normalized = normalizeMac(newMac);
    if (!normalized) {
      alert("âŒ Enter valid MAC (e.g. AABBCCDDEEFF or AA:BB:CC:DD:EE:FF)");
      return;
    }
    clearError(); // Clear previous errors
    const result = await addDevice(normalized, newName.trim());
    if (result.success) {
      setNewMac("");
      setNewName("");
      // Optionally, show a success message
    } else {
      // Error message is already set by the hook
    }
  };

  const handleUpdateDevice = async () => {
    if (!editingDevice) return;
    if (!newName.trim()) {
      alert("Device name cannot be empty.");
      return;
    }
    clearError();
    const result = await updateDevice(editingDevice.macAddress, newName.trim());
    if (result.success) {
      setEditingDevice(null);
      setNewMac("");
      setNewName("");
      // Optionally, show a success message
    } else {
      // Error message is already set by the hook
    }
  };

  const startEdit = (device) => {
    setEditingDevice(device);
    setNewMac(device.macAddress);
    setNewName(device.name);
  };

  const cancelEdit = () => {
    setEditingDevice(null);
    setNewMac("");
    setNewName("");
    clearError();
  };

  const handleLogout = () => {
    localStorage.removeItem("token");
    router.push("/");
  };

  // Show loading state
  if (loading && !devices.length) { // Only show full-page loading if no devices are loaded yet
    return (
      <div className="dashboard-container" style={{display: 'flex', justifyContent: 'center', alignItems: 'center'}}>
        <div className="loading-spinner"></div> Loading Devices...
      </div>
    );
  }

  return (
    <div style={{ backgroundColor: "#f9fafb", color: "#1f2937", fontFamily: "Inter, sans-serif" }}>
      {/* Header */}
      <header className="header">
        <div className="header-container">
          <Link href="/" className="logo">
            <img
              src="/assets/images/Nlogo.png"
              alt="SmartRemote Logo"
              style={{ height: '40px' }}
            />
          </Link>

          <nav className="nav-desktop">
            <Link href="/#features" className="nav-link">Features</Link>
            <Link href="/#how-it-works" className="nav-link">How It Works</Link>
            <Link href="/#specs" className="nav-link">Specifications</Link>
            <Link href="/support" className="nav-link">Support</Link>
          </nav>

          <div className="nav-buttons">
            <Link href="/shop" className="header-btn btn-register">Shop</Link>
            <button onClick={handleLogout} className="header-btn btn-logout">
              Logout
            </button>
          </div>

          <button className="mobile-menu-btn" onClick={() => setIsMenuOpen(!isMenuOpen)}>
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>

          <div className={`mobile-menu ${isMenuOpen ? "open" : ""}`}>
            <div className="mobile-nav-links">
              <Link href="/#features" className="nav-link">Features</Link>
              <Link href="/#how-it-works" className="nav-link">How It Works</Link>
              <Link href="/#specs" className="nav-link">Specifications</Link>
              <Link href="/support" className="nav-link">Support</Link>
            </div>
            <div className="mobile-nav-buttons">
              <Link href="/shop" className="header-btn btn-register">Shop</Link>
              <button onClick={handleLogout} className="header-btn btn-logout">Logout</button>
            </div>
          </div>
        </div>
      </header>

      {/* Dashboard */}
      <div className="dashboard-container">
        <div className="dashboard-content">
          <div className="dashboard-header">
            <div>
              <h1 className="dashboard-title">Device Dashboard</h1>
              <p className="dashboard-welcome">Manage and monitor your smart devices</p>
            </div>
          </div>

          {error && <div className="error-message">{error}</div>}

          {/* Add/Edit Device */}
          <div className="add-device-card">
            <div className="card-title">
              <div className="card-icon">+</div>
              {editingDevice ? 'Edit Device' : 'Add New Device'}
            </div>
            <p className="card-description">
              {editingDevice
                ? `Update details for ${editingDevice.name}.`
                : 'Connect a new smart device to your network by entering its MAC address and giving it a friendly name.'}
            </p>

            <div className="form-grid">
              <div className="input-group">
                <label className="input-label">MAC Address</label>
                <input
                  className="form-input"
                  placeholder="AA:BB:CC:DD:EE:FF or AABBCCDDEEFF"
                  value={newMac}
                  onChange={(e) => setNewMac(e.target.value)}
                  disabled={!!editingDevice || loading} // Disable MAC input when editing or loading
                />
              </div>
              <div className="input-group">
                <label className="input-label">Device Name</label>
                <input
                  className="form-input"
                  placeholder="e.g., Living Room Light"
                  value={newName}
                  onChange={(e) => setNewName(e.target.value)}
                  disabled={loading}
                />
              </div>
            </div>

            <div className="form-actions">
              <button
                className="btn-primary"
                onClick={editingDevice ? handleUpdateDevice : handleAddDevice}
                disabled={loading}
              >
                {loading ? 'Processing...' : (editingDevice ? 'Update Device' : 'Add Device')}
                {loading && <span className="loading-spinner"></span>}
              </button>
              {editingDevice && (
                <button
                  className="btn-secondary"
                  onClick={cancelEdit}
                  disabled={loading}
                >
                  Cancel
                </button>
              )}
            </div>
          </div>

          {/* Device List */}
          {devices.length > 0 && (
            <div className="add-device-card">
              <h2 className="card-title">Your Devices</h2>
              <ul className="devices-list">
                {devices.map((d) => (
                  <li key={d.macAddress} className="device-item">
                    <div className="device-info">
                      <div className="device-name">{d.name}</div>
                      <div className="device-mac">{d.macAddress}</div>
                      {/* You might want to fetch and display actual port count here later */}
                      <div className="device-ports-count">
                        {d.portsCount || 0} port{d.portsCount !== 1 ? 's' : ''}
                      </div>
                    </div>
                    <div className="device-actions">
                      <button
                        className="btn-small"
                        onClick={() => startEdit(d)}
                        disabled={loading}
                      >
                        Edit
                      </button>
                      {/* NEW LINK: Redirect to the Device Ports page */}
                      <Link href={`/device/${d.macAddress}?name=${encodeURIComponent(d.name)}`} className="device-link">
                        Open
                      </Link>
                    </div>
                  </li>
                ))}
              </ul>
            </div>
          )}
          {!devices.length && !loading && (
            <div className="add-device-card" style={{ textAlign: 'center', padding: '2rem' }}>
              <p className="card-description">No devices added yet. Use the form above to get started!</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

export default withAuth(DashboardPage);


### Step 4: Create app/device/[mac]/page.js (Device Details / Port Listing Page)
This new page will be the "middle layer" that lists switches (ports) for a specific device and allows adding new ones.

// app/device/[mac]/page.js
"use client";

import { useState, useEffect, use, useCallback } from 'react';
import Link from 'next/link';
import { useRouter, useSearchParams } from 'next/navigation';
import withAuth from '../../../lib/withAuth';
import { useDevices } from '../../../hooks/useDevices'; // Import the hook

function DevicePortsPage({ params }) {
  const { mac } = use(params); // Get mac from URL params
  const searchParams = useSearchParams();
  const deviceName = searchParams.get('name') || `Device ${mac}`;
  const router = useRouter();

  const { fetchPortsForDevice, addPort, loading, error, clearError } = useDevices();
  const [ports, setPorts] = useState([]);
  const [newPortName, setNewPortName] = useState("");
  const [newPortPin, setNewPortPin] = useState(1);
  const [isMenuOpen, setIsMenuOpen] = useState(false); // For mobile header

  const fetchCurrentPorts = useCallback(async () => {
    const result = await fetchPortsForDevice(mac);
    if (result.success) {
      setPorts(result.ports);
    }
  }, [mac, fetchPortsForDevice]);

  useEffect(() => {
    fetchCurrentPorts();
  }, [fetchCurrentPorts]);

  // Inject custom CSS (you might want to consolidate this)
  useEffect(() => {
    const styleElement = document.createElement("style");
    styleElement.textContent = `
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

      html { scroll-behavior: smooth; }
      body {
        font-family: 'Inter', sans-serif !important;
        overflow-y: scroll;
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
      }
      body::-webkit-scrollbar { width: 8px; }
      body::-webkit-scrollbar-track { background: transparent; }
      body::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        border: 2px solid transparent;
        background-clip: content-box;
      }
      body::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.4); }

      /* HEADER (Copied from Dashboard) */
      .header {
        position: fixed; top: 0; left: 0; right: 0;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(229, 231, 235, 0.5);
        z-index: 40; padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
      }
      .header-container {
        max-width: 80rem; margin: 0 auto;
        display: flex; align-items: center; justify-content: space-between;
      }
      .logo {
        display: flex; align-items: center; gap: 0.75rem;
        text-decoration: none; color: #1f2937;
        font-weight: 800; font-size: 1.5rem;
        transition: color 0.3s ease;
      }
      .logo:hover { color: #2563eb; }
      .logo-icon {
        width: 2.5rem; height: 2.5rem;
        background: linear-gradient(to right, #3b82f6, #06b6d4);
        border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;
        color: white; font-weight: 700;
      }
      .nav-desktop { display: none; align-items: center; gap: 2rem; }
      @media (min-width: 1024px) { .nav-desktop { display: flex; } }
      .nav-link {
        color: #374151; text-decoration: none;
        font-weight: 500; padding: 0.5rem 1rem;
        border-radius: 0.5rem; transition: all 0.3s ease;
      }
      .nav-link:hover { color: #2563eb; background-color: #f3f4f6; }
      .nav-buttons { display: none; align-items: center; gap: 1rem; }
      @media (min-width: 1024px) { .nav-buttons { display: flex; } }
      .header-btn {
        padding: 0.5rem 1rem; border-radius: 0.5rem;
        font-weight: 600; text-decoration: none;
        transition: all 0.3s ease; border: none; cursor: pointer;
      }
      .btn-login { color: #374151; background: transparent; }
      .btn-login:hover { background-color: #f3f4f6; }
      .btn-register { color: white; background-color: #2563eb; }
      .btn-register:hover { background-color: #1d4ed8; }
      .btn-logout {
        color: white; background: linear-gradient(to right, #dc2626, #b91c1c);
      }
      .btn-logout:hover {
        background: linear-gradient(to right, #b91c1c, #991b1b);
      }
      .mobile-menu-btn { display: block; background: none; border: none; padding: 0.5rem; cursor: pointer; }
      @media (min-width: 1024px) { .mobile-menu-btn { display: none; } }
      .mobile-menu {
        position: absolute; top: 100%; left: 0; right: 0;
        background: white; border-bottom: 1px solid rgba(229, 231, 235, 0.5);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        display: none; padding: 1rem;
      }
      .mobile-menu.open { display: block; }
      .mobile-nav-links {
        display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;
      }
      .mobile-nav-buttons { display: flex; flex-direction: column; gap: 0.5rem; }

      /* PAGE CONTAINER */
      .device-ports-container {
        min-height: 100vh;
        background: linear-gradient(135deg, #f8faff 0%, #ffffff 100%);
        padding: 8rem 1.5rem 5rem 1.5rem;
        position: relative; overflow: hidden;
      }
      .device-ports-container::before {
        content: ''; position: absolute; top: 0; right: -50%;
        width: 100%; height: 100%;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
        border-radius: 50%; z-index: 1;
      }
      .device-ports-content { max-width: 80rem; margin: 0 auto; position: relative; z-index: 2; }

      /* DEVICE HEADER */
      .device-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 3rem; flex-wrap: wrap; gap: 1rem;
      }
      .device-title {
        font-size: 2.5rem; font-weight: 800; color: #111827; line-height: 1.1; margin: 0;
      }
      @media (min-width: 768px) { .device-title { font-size: 3rem; } }
      .device-subtitle { color: #6b7280; font-size: 1.125rem; margin-top: 0.5rem; }

      /* CARD STYLES (Reused from Dashboard) */
      .card {
        background: white;
        border-radius: 1.5rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: 1px solid rgba(229, 231, 235, 0.5);
        backdrop-filter: blur(10px);
        padding: 2.5rem;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
      }
      .card:hover {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }
      .card-title {
        font-size: 1.5rem; font-weight: 700; color: #111827;
        margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem;
      }
      .card-icon {
        width: 2rem; height: 2rem;
        background: linear-gradient(to right, #3b82f6, #06b6d4);
        border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; color: white;
      }
      .card-description { color: #6b7280; margin-bottom: 2rem; line-height: 1.6; }

      /* FORM ELEMENTS (Reused) */
      .form-grid { display: grid; gap: 1.5rem; margin-bottom: 2rem; }
      @media (min-width: 768px) { .form-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } }
      .input-group { display: flex; flex-direction: column; gap: 0.5rem; }
      .input-label { font-weight: 600; color: #374151; font-size: 0.875rem; }
      .form-input {
        padding: 0.875rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #f9fafb;
      }
      .form-input:focus {
        outline: none; border-color: #2563eb;
        background: white; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }
      .form-input::placeholder { color: #9ca3af; }

      /* BUTTONS (Reused) */
      .btn-primary {
        background: linear-gradient(to right, #2563eb, #1d4ed8);
        color: white; padding: 0.875rem 2rem;
        border-radius: 0.75rem; font-weight: 600;
        border: none; cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
        display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        height: fit-content; align-self: end; white-space: nowrap;
      }
      .btn-primary:hover {
        background: linear-gradient(to right, #1d4ed8, #1e40af);
        transform: translateY(-1px);
        box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
      }
      .btn-secondary {
        background: white;
        color: #374151;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        border: 1px solid #d1d5db;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .btn-secondary:hover {
        background: #f9fafb;
      }
      .form-actions { display: flex; gap: 0.5rem; align-items: center; }

      /* PORTS LIST */
      .ports-list-section {
        margin-top: 2rem;
      }
      .ports-list { list-style: none; padding: 0; margin: 0; }
      .port-item {
        background: white;
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s ease;
      }
      .port-item:last-child { border-bottom: none; }
      .port-item:hover {
        background-color: #f3f4f6;
      }
      .port-info { color: #374151; }
      .port-name { font-weight: 600; }
      .port-pin { font-size: 0.875rem; color: #6b7280; }
      .port-link {
        color: #2563eb; font-weight: 500; text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        background-color: #e0f2fe;
        transition: all 0.2s ease;
      }
      .port-link:hover {
        background-color: #bfdbfe;
        text-decoration: none;
      }
      .error-message {
        background-color: #fee2e2;
        border: 1px solid #fca5a5;
        color: #991b1b;
        padding: 0.75rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        text-align: center;
      }
      .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-top: 4px solid #2563eb;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin-left: 0.5rem;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .action-buttons {
        display: flex; justify-content: flex-start; align-items: center;
        margin-top: 2rem; padding: 1rem 0;
        border-top: 1px solid #e5e7eb;
      }
      .btn-back {
        background: linear-gradient(to right, #3b82f6, #1d4ed8);
        color: white; padding: 0.75rem 1.25rem; border-radius: 0.5rem;
        font-weight: 600; border: none; cursor: pointer; transition: all 0.3s ease;
        text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;
      }
      .btn-back:hover { transform: translateY(-1px); box-shadow: 0 8px 20px -6px rgba(29,78,216,0.4); }

    `;
    document.head.appendChild(styleElement);
    return () => { document.head.removeChild(styleElement); };
  }, []);

  const handleAddPort = async () => {
    if (!newPortName.trim()) {
      alert("Please enter a name for the port.");
      return;
    }

    // Check if pin is already assigned
    if (ports.some(port => port.pin === newPortPin)) {
      alert(`Pin ${newPortPin} is already in use for this device. Please choose a different pin.`);
      return;
    }

    clearError();
    const result = await addPort(mac, newPortName.trim(), newPortPin);
    if (result.success) {
      setNewPortName("");
      // No need to manually update `ports` here, `fetchCurrentPorts` will get the latest
      await fetchCurrentPorts();
    }
    // Error message is already handled by the hook
  };

  const handleLogout = () => {
    localStorage.removeItem("token");
    router.push("/");
  };

  const handleBack = () => {
    router.push('/dashboard'); // Go back to the dashboard
  };

  // Generate an array of available pin numbers (1 to 8)
  const availablePins = Array.from({ length: 8 }, (_, i) => i + 1)
    .filter(pin => !ports.some(port => port.pin === pin)); // Filter out already used pins

  // Show loading state
  if (loading && !ports.length) { // Only show full-page loading if no ports are loaded yet
    return (
      <div className="device-ports-container" style={{display: 'flex', justifyContent: 'center', alignItems: 'center'}}>
        <div className="loading-spinner"></div> Loading Ports...
      </div>
    );
  }

  return (
    <div style={{ backgroundColor: "#f9fafb", color: "#1f2937", fontFamily: "Inter, sans-serif" }}>
      {/* Header */}
      <header className="header">
        <div className="header-container">
          <Link href="/" className="logo">
            <img
              src="/assets/images/Nlogo.png"
              alt="SmartRemote Logo"
              style={{ height: '40px' }}
            />
          </Link>

          <nav className="nav-desktop">
            <Link href="/#features" className="nav-link">Features</Link>
            <Link href="/#how-it-works" className="nav-link">How It Works</Link>
            <Link href="/#specs" className="nav-link">Specifications</Link>
            <Link href="/support" className="nav-link">Support</Link>
          </nav>

          <div className="nav-buttons">
            <Link href="/shop" className="header-btn btn-register">Shop</Link>
            <button onClick={handleLogout} className="header-btn btn-logout">
              Logout
            </button>
          </div>

          <button className="mobile-menu-btn" onClick={() => setIsMenuOpen(!isMenuOpen)}>
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>

          <div className={`mobile-menu ${isMenuOpen ? "open" : ""}`}>
            <div className="mobile-nav-links">
              <Link href="/#features" className="nav-link">Features</Link>
              <Link href="/#how-it-works" className="nav-link">How It Works</Link>
              <Link href="/#specs" className="nav-link">Specifications</Link>
              <Link href="/support" className="nav-link">Support</Link>
            </div>
            <div className="mobile-nav-buttons">
              <Link href="/shop" className="header-btn btn-register">Shop</Link>
              <button onClick={handleLogout} className="header-btn btn-logout">Logout</button>
            </div>
          </div>
        </div>
      </header>

      {/* Device Ports Page Content */}
      <div className="device-ports-container">
        <div className="device-ports-content">
          <div className="device-header">
            <div>
              <h1 className="device-title">{deviceName}</h1>
              <p className="device-subtitle">Manage switches for this device (MAC: {mac})</p>
            </div>
          </div>

          {error && <div className="error-message">{error}</div>}

          {/* Add New Port (Switch) */}
          <div className="card">
            <div className="card-title">
              <div className="card-icon">ðŸ”Œ</div> {/* Changed icon to a plug */}
              Add New Switch
            </div>
            <p className="card-description">
              Connect a new switch/port to this device. Choose a unique pin (1-8) and give it a friendly name.
            </p>

            <div className="form-grid">
              <div className="input-group">
                <label className="input-label">Switch Name</label>
                <input
                  className="form-input"
                  placeholder="e.g., Living Room Fan"
                  value={newPortName}
                  onChange={(e) => setNewPortName(e.target.value)}
                  disabled={loading}
                />
              </div>
              <div className="input-group">
                <label className="input-label">Pin Number (1-8)</label>
                <select
                  className="form-input"
                  value={newPortPin}
                  onChange={(e) => setNewPortPin(Number(e.target.value))}
                  disabled={loading || availablePins.length === 0}
                >
                  {availablePins.length > 0 ? (
                    availablePins.map(pin => (
                      <option key={pin} value={pin}>Pin {pin}</option>
                    ))
                  ) : (
                    <option value="">No pins available</option>
                  )}
                </select>
              </div>
            </div>

            <div className="form-actions" style={{ justifyContent: 'flex-start' }}>
              <button
                className="btn-primary"
                onClick={handleAddPort}
                disabled={loading || !newPortName.trim() || availablePins.length === 0}
              >
                {loading ? 'Adding...' : 'Add Switch'}
                {loading && <span className="loading-spinner"></span>}
              </button>
            </div>
          </div>

          {/* List of Switches (Ports) */}
          <div className="card ports-list-section">
            <h2 className="card-title">Configured Switches</h2>
            <ul className="ports-list">
              {ports.length > 0 ? (
                ports.map((port) => (
                  <li key={port.pin} className="port-item">
                    <div className="port-info">
                      <div className="port-name">{port.name}</div>
                      <div className="port-pin">Pin: {port.pin}</div>
                    </div>
                    {/* NEW LINK: Redirect to individual switch control page */}
                    <Link
                      href={`/device/${mac}/${port.pin}?deviceName=${encodeURIComponent(deviceName)}&portName=${encodeURIComponent(port.name)}`}
                      className="port-link"
                    >
                      Control
                    </Link>
                  </li>
                ))
              ) : (
                <li className="port-item" style={{ justifyContent: 'center', fontStyle: 'italic', color: '#6b7280' }}>
                  No switches configured for this device. Add one above!
                </li>
              )}
            </ul>
          </div>

          {/* Bottom action buttons */}
          <div className="action-buttons">
            <button onClick={handleBack} className="btn-back">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M10 19l-7-7 7-7v4h8v6h-8v4z" />
              </svg>
              Back to Dashboard
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

export default withAuth(DevicePortsPage);```

---

### **Step 5: Create `app/device/[mac]/[pin]/page.js` (Individual Switch Control Page)**

This page will be responsible for displaying the status of a single switch/port, toggling it, and managing its schedules.

```javascript
// app/device/[mac]/[pin]/page.js
"use client";

import { useState, useEffect, use, useCallback } from 'react';
import Link from 'next/link';
import { useRouter, useSearchParams } from 'next/navigation';
import withAuth from '../../../../lib/withAuth';
import { useDevices } from '../../../../hooks/useDevices'; // Import the hook

function IndividualSwitchControlPage({ params }) {
  const { mac, pin } = use(params); // Get mac and pin from URL params
  const searchParams = useSearchParams();
  const deviceName = searchParams.get('deviceName') || `Device ${mac}`;
  const portName = searchParams.get('portName') || `Switch Pin ${pin}`;
  const router = useRouter();

  const { fetchPinStatus, togglePinStatus, fetchSchedules, createSchedule, deleteSchedule, loading, error, clearError } = useDevices();
  const [isOn, setIsOn] = useState(false); // Current status of the switch
  const [schedules, setSchedules] = useState([]); // Schedules for THIS specific port
  const [formSchedule, setFormSchedule] = useState({ name: '', time: '', action: 'Turn On', day: 'Monday' });
  const [isMenuOpen, setIsMenuOpen] = useState(false); // For mobile header

  // Fetch initial pin status
  const fetchCurrentPinStatus = useCallback(async () => {
    const result = await fetchPinStatus(mac, pin);
    if (result.success) {
      setIsOn(result.status === '1');
    }
  }, [mac, pin, fetchPinStatus]);

  // Fetch schedules for this specific pin
  const fetchCurrentSchedules = useCallback(async () => {
    const result = await fetchSchedules();
    if (result.success) {
      // Filter schedules to only show those for the current device and pin
      const filteredSchedules = result.schedules.filter(s =>
        s.macSymbolId === mac && s.switchPin === String(pin)
      );
      setSchedules(filteredSchedules);
    }
  }, [mac, pin, fetchSchedules]);

  useEffect(() => {
    fetchCurrentPinStatus();
    fetchCurrentSchedules();
  }, [fetchCurrentPinStatus, fetchCurrentSchedules]);

  // Inject custom CSS (you might want to consolidate this)
  useEffect(() => {
    const styleElement = document.createElement("style");
    styleElement.textContent = `
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

      html { scroll-behavior: smooth; }
      body {
        font-family: 'Inter', sans-serif !important;
        overflow-y: scroll;
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
      }
      body::-webkit-scrollbar { width: 8px; }
      body::-webkit-scrollbar-track { background: transparent; }
      body::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        border: 2px solid transparent;
        background-clip: content-box;
      }
      body::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.4); }

      /* HEADER (Copied from Dashboard) */
      .header {
        position: fixed; top: 0; left: 0; right: 0;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(229, 231, 235, 0.5);
        z-index: 40; padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
      }
      .header-container {
        max-width: 80rem; margin: 0 auto;
        display: flex; align-items: center; justify-content: space-between;
      }
      .logo {
        display: flex; align-items: center; gap: 0.75rem;
        text-decoration: none; color: #1f2937;
        font-weight: 800; font-size: 1.5rem;
        transition: color 0.3s ease;
      }
      .logo:hover { color: #2563eb; }
      .logo-icon {
        width: 2.5rem; height: 2.5rem;
        background: linear-gradient(to right, #3b82f6, #06b6d4);
        border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;
        color: white; font-weight: 700;
      }
      .nav-desktop { display: none; align-items: center; gap: 2rem; }
      @media (min-width: 1024px) { .nav-desktop { display: flex; } }
      .nav-link {
        color: #374151; text-decoration: none;
        font-weight: 500; padding: 0.5rem 1rem;
        border-radius: 0.5rem; transition: all 0.3s ease;
      }
      .nav-link:hover { color: #2563eb; background-color: #f3f4f6; }
      .nav-buttons { display: none; align-items: center; gap: 1rem; }
      @media (min-width: 1024px) { .nav-buttons { display: flex; } }
      .header-btn {
        padding: 0.5rem 1rem; border-radius: 0.5rem;
        font-weight: 600; text-decoration: none;
        transition: all 0.3s ease; border: none; cursor: pointer;
      }
      .btn-login { color: #374151; background: transparent; }
      .btn-login:hover { background-color: #f3f4f6; }
      .btn-register { color: white; background-color: #2563eb; }
      .btn-register:hover { background-color: #1d4ed8; }
      .btn-logout {
        color: white; background: linear-gradient(to right, #dc2626, #b91c1c);
      }
      .btn-logout:hover {
        background: linear-gradient(to right, #b91c1c, #991b1b);
      }
      .mobile-menu-btn { display: block; background: none; border: none; padding: 0.5rem; cursor: pointer; }
      @media (min-width: 1024px) { .mobile-menu-btn { display: none; } }
      .mobile-menu {
        position: absolute; top: 100%; left: 0; right: 0;
        background: white; border-bottom: 1px solid rgba(229, 231, 235, 0.5);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        display: none; padding: 1rem;
      }
      .mobile-menu.open { display: block; }
      .mobile-nav-links {
        display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;
      }
      .mobile-nav-buttons { display: flex; flex-direction: column; gap: 0.5rem; }

      /* PAGE CONTAINER */
      .switch-control-container {
        min-height: 100vh;
        background: linear-gradient(135deg, #f8faff 0%, #ffffff 100%);
        padding: 8rem 1.5rem 5rem 1.5rem;
        position: relative; overflow: hidden;
      }
      .switch-control-container::before {
        content: ''; position: absolute; top: 0; right: -50%;
        width: 100%; height: 100%;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
        border-radius: 50%; z-index: 1;
      }
      .switch-control-content { max-width: 80rem; margin: 0 auto; position: relative; z-index: 2; }

      /* SWITCH HEADER */
      .switch-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 3rem; flex-wrap: wrap; gap: 1rem;
      }
      .switch-title {
        font-size: 2.5rem; font-weight: 800; color: #111827; line-height: 1.1; margin: 0;
      }
      @media (min-width: 768px) { .switch-title { font-size: 3rem; } }
      .switch-subtitle { color: #6b7280; font-size: 1.125rem; margin-top: 0.5rem; }

      /* STATUS INDICATOR */
      .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.875rem;
      }
      .status-indicator.on {
        background-color: #dcfce7; /* green-100 */
        color: #16a34a; /* green-700 */
      }
      .status-indicator.off {
        background-color: #fee2e2; /* red-100 */
        color: #dc2626; /* red-700 */
      }
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }
      .status-dot.on { background-color: #16a34a; }
      .status-dot.off { background-color: #dc2626; }

      /* TOGGLE BUTTON */
      .power-toggle-button {
        background: linear-gradient(to right, #2563eb, #1d4ed8);
        color: white; padding: 1rem 2rem;
        border-radius: 0.75rem; font-size: 1.125rem;
        font-weight: 600;
        border: none; cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
        display: flex; align-items: center; justify-content: center; gap: 0.5rem;
      }
      .power-toggle-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 25px -5px rgba(37, 99, 235, 0.4);
      }
      .power-toggle-button.on {
        background: linear-gradient(to right, #dc2626, #b91c1c); /* red */
        box-shadow: 0 10px 15px -3px rgba(220, 38, 38, 0.3);
      }
      .power-toggle-button.on:hover {
        background: linear-gradient(to right, #b91c1c, #991b1b);
        box-shadow: 0 20px 25px -5px rgba(220, 38, 38, 0.4);
      }
      .power-toggle-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* CARD STYLES (Reused from Dashboard) */
      .card {
        background: white;
        border-radius: 1.5rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: 1px solid rgba(229, 231, 235, 0.5);
        backdrop-filter: blur(10px);
        padding: 2.5rem;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
      }
      .card:hover {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }
      .card-title {
        font-size: 1.5rem; font-weight: 700; color: #111827;
        margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem;
      }
      .card-icon {
        width: 2rem; height: 2rem;
        background: linear-gradient(to right, #3b82f6, #06b6d4);
        border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; color: white;
      }
      .card-description { color: #6b7280; margin-bottom: 2rem; line-height: 1.6; }

      /* FORM ELEMENTS (Reused) */
      .form-grid { display: grid; gap: 1.5rem; margin-bottom: 2rem; }
      @media (min-width: 768px) { .form-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); } }
      .input-group { display: flex; flex-direction: column; gap: 0.5rem; }
      .input-label { font-weight: 600; color: #374151; font-size: 0.875rem; }
      .form-input {
        padding: 0.875rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #f9fafb;
      }
      .form-input:focus {
        outline: none; border-color: #2563eb;
        background: white; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }
      .form-input::placeholder { color: #9ca3af; }

      /* SCHEDULES LIST */
      .schedules-list-section {
        margin-top: 2rem;
      }
      .schedules-list { list-style: none; padding: 0; margin: 0; }
      .schedule-item {
        background: white;
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s ease;
      }
      .schedule-item:last-child { border-bottom: none; }
      .schedule-item:hover {
        background-color: #f3f4f6;
      }
      .schedule-info { color: #374151; }
      .schedule-name { font-weight: 600; }
      .schedule-details { font-size: 0.875rem; color: #6b7280; }
      .delete-schedule-btn {
        background-color: #dc2626; /* red-600 */
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .delete-schedule-btn:hover {
        background-color: #b91c1c; /* red-700 */
        transform: translateY(-1px);
      }
      .delete-schedule-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .error-message {
        background-color: #fee2e2;
        border: 1px solid #fca5a5;
        color: #991b1b;
        padding: 0.75rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        text-align: center;
      }
      .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-top: 4px solid #2563eb;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin-left: 0.5rem;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .action-buttons {
        display: flex; justify-content: flex-start; align-items: center;
        margin-top: 2rem; padding: 1rem 0;
        border-top: 1px solid #e5e7eb;
      }
      .btn-back {
        background: linear-gradient(to right, #3b82f6, #1d4ed8);
        color: white; padding: 0.75rem 1.25rem; border-radius: 0.5rem;
        font-weight: 600; border: none; cursor: pointer; transition: all 0.3s ease;
        text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;
      }
      .btn-back:hover { transform: translateY(-1px); box-shadow: 0 8px 20px -6px rgba(29,78,216,0.4); }

    `;
    document.head.appendChild(styleElement);
    return () => { document.head.removeChild(styleElement); };
  }, []);

  const handleToggleSwitch = async () => {
    clearError();
    const result = await togglePinStatus(mac, pin, isOn ? '1' : '0');
    if (result.success) {
      setIsOn(result.newState === '1');
    }
  };

  const handleCreateSchedule = async () => {
    if (!formSchedule.name.trim() || !formSchedule.time.trim() || !formSchedule.day.trim()) {
      alert("Please fill in all schedule fields.");
      return;
    }

    clearError();

    const now = new Date();
    const [hours, minutes] = formSchedule.time.split(':').map(Number);
    const scheduleDateTime = new Date(now);
    scheduleDateTime.setHours(hours, minutes, 0, 0);

    // Backend expects specific time format for onTime/offTime
    // We need to define if 'Turn On' means onTime or offTime
    // Assuming 'Turn On' implies setting an onTime, and 'Turn Off' sets an offTime
    const scheduleTimes = {};
    if (formSchedule.action === 'Turn On') {
      scheduleTimes.onTime = scheduleDateTime.toISOString();
      // For simplicity, if only onTime is given, offTime might be derived by backend or set a default.
      // Or, the user needs to provide both. For now, we'll send only one if the action is singular.
      // If the backend requires both, this logic needs adjustment.
      // Let's assume for now, schedule creation handles one action (ON/OFF) at a specific time.
      // For a proper range (ON to OFF), the form needs two time inputs.
      // Based on your API: scheduleTimes: { offTime: "...", onTime: "..." }
      // This implies a range. Let's adapt the form for a simple "trigger at time" and handle backend logic.
      // If the API demands a range, the frontend form needs "start time" and "end time".
      // Given the example, it wants both `onTime` and `offTime`.
      // For a single "Turn On" or "Turn Off" event, the backend would need to handle this.
      // For now, let's assume `createSchedule` expects both `onTime` and `offTime`, so the form logic needs adjustment
      // to capture both or define one as default.

      // As per your backend API example, it expects both onTime and offTime for a schedule.
      // This means the current simple "time" and "action" for a schedule doesn't directly map.
      // Let's modify `formSchedule` to also have `offTime` if we want to create a range,
      // or simplify the backend `create schedule` API to handle single point events.
      // For this implementation, I'll assume a `createSchedule` event means a single time point for action.
      // The API `scheduleTimes: { offTime: "2025-09-02T06:54:11Z", onTime: "2025-09-02T06:55:11Z" }`
      // implies a range. This is a mismatch.

      // To proceed, I'll assume a simplified interpretation:
      // If action is "Turn On", `onTime` is set, and `offTime` is null/default.
      // If action is "Turn Off", `offTime` is set, and `onTime` is null/default.
      // This might require a backend change if it strictly expects both.
      // Or, for the frontend, we require *both* an 'on' time and an 'off' time input.

      // Let's assume the form `time` is the trigger time, and `action` specifies what happens.
      // The backend will receive this and translate it into a valid 'onTime' or 'offTime' range
      // or just store the single event.
      // The backend API example (`scheduleTimes: { offTime: "...", onTime: "..." }`) suggests
      // it always wants both. This is a common pattern for "period" schedules.

      // If we keep the current form, we need to decide what to send for the *other* time.
      // Let's make `formSchedule` accept two times for clarity or simplify.
      // For now, for the schedule object for the API, I will construct `onTime` and `offTime`
      // where one is the current `time` and the other is a default or placeholder.
      // This might not be what your backend expects perfectly given its API.

      // Let's stick to the backend API example of a time range,
      // so the form needs to capture both an ON time and an OFF time.
      // I'll adjust the `formSchedule` and UI to reflect this.

      const currentDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0];
      const onTimeISO = `${currentDay}T${formSchedule.time}:00Z`; // Assume formSchedule.time is 'HH:MM'
      let offTimeISO = `${currentDay}T${formSchedule.time}:00Z`; // Placeholder, should be different

      // For simplicity in this `createSchedule` button flow,
      // let's assume `formSchedule.action` means a one-time event *at* `formSchedule.time`
      // which turns ON or OFF the device. This contradicts the backend API which expects a range.
      // This is a design decision you need to clarify.

      // Given the API expects both onTime and offTime, let's just make the simple form
      // create a schedule for "now" and "now + 1 minute" for simplicity, this is not good UX
      // but aligns with API for a test.
      // Or, better, modify the form to have an 'ON time' and 'OFF time' input,
      // similar to the commented-out `app/device/[mac]/page.js` version.

      // Let's assume the current simple time input (`formSchedule.time`)
      // represents an *action point*, not a duration.
      // This means the API `create schdule` expecting `onTime` AND `offTime` is problematic for this UI.

      // For demonstration, let's create a placeholder for the `offTime` if only `onTime` is provided,
      // or vice-versa, but this might break backend validation.
      // The most robust way is to make the form collect `onTime` and `offTime` explicitly.
      // I will keep the simple time input, but will generate an `onTime` and `offTime`
      // based on the `action` and `time` to fit the API.

      let finalOnTime = null;
      let finalOffTime = null;

      if (formSchedule.action === 'Turn On') {
        finalOnTime = scheduleDateTime.toISOString();
        // Placeholder for offTime, assuming it must be later
        const defaultOffDateTime = new Date(scheduleDateTime.getTime() + 60 * 60 * 1000); // 1 hour later
        finalOffTime = defaultOffDateTime.toISOString();
      } else { // Turn Off
        finalOffTime = scheduleDateTime.toISOString();
        // Placeholder for onTime, assuming it must be earlier
        const defaultOnDateTime = new Date(scheduleDateTime.getTime() - 60 * 60 * 1000); // 1 hour earlier
        finalOnTime = defaultOnDateTime.toISOString();
      }

      const scheduleData = {
        name: formSchedule.name.trim(),
        macSymbolId: mac,
        switchPin: String(pin), // Ensure pin is a string if API expects it
        scheduleTimes: {
          onTime: finalOnTime,
          offTime: finalOffTime,
        },
        day: formSchedule.day // Assuming backend can store/process day
      };

      const result = await createSchedule(scheduleData);
      if (result.success) {
        setFormSchedule({ name: '', time: '', action: 'Turn On', day: 'Monday' });
        await fetchCurrentSchedules(); // Refresh the schedules list
      }
      // Error is handled by the hook
  };

  const handleDeleteSchedule = async (scheduleId) => {
    clearError();
    const result = await deleteSchedule(scheduleId);
    if (result.success) {
      await fetchCurrentSchedules(); // Refresh the schedules list
    }
    // Error is handled by the hook
  };

  const handleLogout = () => {
    localStorage.removeItem("token");
    router.push("/");
  };

  const handleBack = () => {
    router.push(`/device/${mac}?name=${encodeURIComponent(deviceName)}`); // Go back to the device's port list
  };

  // Helper to format ISO date string to local time string (HH:MM)
  const formatTime = (isoString) => {
    if (!isoString) return 'N/A';
    const date = new Date(isoString);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  };

  // Show loading state
  if (loading && !schedules.length && !isOn) { // Only show full-page loading if initial data isn't loaded
    return (
      <div className="switch-control-container" style={{display: 'flex', justifyContent: 'center', alignItems: 'center'}}>
        <div className="loading-spinner"></div> Loading Switch Data...
      </div>
    );
  }

  return (
    <div style={{ backgroundColor: "#f9fafb", color: "#1f2937", fontFamily: "Inter, sans-serif" }}>
      {/* Header */}
      <header className="header">
        <div className="header-container">
          <Link href="/" className="logo">
            <img
              src="/assets/images/Nlogo.png"
              alt="SmartRemote Logo"
              style={{ height: '40px' }}
            />
          </Link>

          <nav className="nav-desktop">
            <Link href="/#features" className="nav-link">Features</Link>
            <Link href="/#how-it-works" className="nav-link">How It Works</Link>
            <Link href="/#specs" className="nav-link">Specifications</Link>
            <Link href="/support" className="nav-link">Support</Link>
          </nav>

          <div className="nav-buttons">
            <Link href="/shop" className="header-btn btn-register">Shop</Link>
            <button onClick={handleLogout} className="header-btn btn-logout">
              Logout
            </button>
          </div>

          <button className="mobile-menu-btn" onClick={() => setIsMenuOpen(!isMenuOpen)}>
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>

          <div className={`mobile-menu ${isMenuOpen ? "open" : ""}`}>
            <div className="mobile-nav-links">
              <Link href="/#features" className="nav-link">Features</Link>
              <Link href="/#how-it-works" className="nav-link">How It Works</Link>
              <Link href="/#specs" className="nav-link">Specifications</Link>
              <Link href="/support" className="nav-link">Support</Link>
            </div>
            <div className="mobile-nav-buttons">
              <Link href="/shop" className="header-btn btn-register">Shop</Link>
              <button onClick={handleLogout} className="header-btn btn-logout">Logout</button>
            </div>
          </div>
        </div>
      </header>

      {/* Individual Switch Control Content */}
      <div className="switch-control-container">
        <div className="switch-control-content">
          <div className="switch-header">
            <div>
              <h1 className="switch-title">{portName}</h1>
              <p className="switch-subtitle">
                Device: {deviceName} (MAC: {mac}) | Pin: {pin}
              </p>
              <div className={`status-indicator ${isOn ? 'on' : 'off'}`}>
                <div className={`status-dot ${isOn ? 'on' : 'off'}`}></div>
                {isOn ? 'ON' : 'OFF'}
              </div>
            </div>
            <button
              className={`power-toggle-button ${isOn ? 'on' : ''}`}
              onClick={handleToggleSwitch}
              disabled={loading}
            >
              {loading ? 'Toggling...' : (isOn ? 'Turn OFF' : 'Turn ON')}
              {loading && <span className="loading-spinner"></span>}
            </button>
          </div>

          {error && <div className="error-message">{error}</div>}

          {/* Create Schedule */}
          <div className="card">
            <div className="card-title">
              <div className="card-icon">â°</div> {/* Changed icon to a clock */}
              Create New Schedule
            </div>
            <p className="card-description">
              Set a time, action (Turn On/Off), and day for this switch to automate its behavior.
            </p>

            <div className="form-grid">
              <div className="input-group">
                <label className="input-label">Schedule Name</label>
                <input
                  className="form-input"
                  type="text"
                  placeholder="e.g., Morning Light"
                  value={formSchedule.name}
                  onChange={(e) => setFormSchedule({...formSchedule, name: e.target.value})}
                  disabled={loading}
                />
              </div>
              <div className="input-group">
                <label className="input-label">Time (HH:MM)</label>
                <input
                  className="form-input"
                  type="time"
                  value={formSchedule.time}
                  onChange={(e) => setFormSchedule({...formSchedule, time: e.target.value})}
                  disabled={loading}
                />
              </div>
              <div className="input-group">
                <label className="input-label">Action</label>
                <select
                  className="form-input"
                  value={formSchedule.action}
                  onChange={(e) => setFormSchedule({...formSchedule, action: e.target.value})}
                  disabled={loading}
                >
                  <option value="Turn On">Turn On</option>
                  <option value="Turn Off">Turn Off</option>
                </select>
              </div>
              <div className="input-group">
                <label className="input-label">Day</label>
                <select
                  className="form-input"
                  value={formSchedule.day}
                  onChange={(e) => setFormSchedule({...formSchedule, day: e.target.value})}
                  disabled={loading}
                >
                  {['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday', 'Every Day']
                    .map(day => (
                      <option key={day} value={day}>{day}</option>
                    ))}
                </select>
              </div>
            </div>

            <div className="form-actions" style={{ justifyContent: 'flex-start' }}>
              <button
                className="btn-primary"
                onClick={handleCreateSchedule}
                disabled={loading || !formSchedule.name.trim() || !formSchedule.time.trim()}
              >
                {loading ? 'Saving...' : 'Add Schedule'}
                {loading && <span className="loading-spinner"></span>}
              </button>
            </div>
          </div>

          {/* List of Schedules */}
          <div className="card schedules-list-section">
            <h2 className="card-title">Active Schedules</h2>
            <ul className="schedules-list">
              {schedules.length > 0 ? (
                schedules.map((schedule) => (
                  <li key={schedule._id} className="schedule-item">
                    <div className="schedule-info">
                      <div className="schedule-name">{schedule.name}</div>
                      <div className="schedule-details">
                        {formatTime(schedule.scheduleTimes.onTime)} - {formatTime(schedule.scheduleTimes.offTime)} on {schedule.day || 'N/A'}
                      </div>
                    </div>
                    <button
                      className="delete-schedule-btn"
                      onClick={() => handleDeleteSchedule(schedule._id)}
                      disabled={loading}
                    >
                      Delete
                    </button>
                  </li>
                ))
              ) : (
                <li className="schedule-item" style={{ justifyContent: 'center', fontStyle: 'italic', color: '#6b7280' }}>
                  No schedules set for this switch.
                </li>
              )}
            </ul>
          </div>

          {/* Bottom action buttons */}
          <div className="action-buttons">
            <button onClick={handleBack} className="btn-back">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M10 19l-7-7 7-7v4h8v6h-8v4z" />
              </svg>
              Back to Switches
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

export default withAuth(IndividualSwitchControlPage);